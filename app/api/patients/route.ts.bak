// app/api/patients/route.ts

import { NextResponse } from 'next/server';
import prisma from '@/lib/prisma';
import { withAuth, type AuthenticatedApiHandler } from '@/lib/auth-handler';
import { patientFormSchema } from '@/schemas/community/patient.schema';
import { z } from 'zod';

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏®
const getGenderFromPrefix = (prefix: string): '‡∏ä‡∏≤‡∏¢' | '‡∏´‡∏ç‡∏¥‡∏á' => {
  if (['‡∏ô‡∏≤‡∏¢', '‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢'].includes(prefix)) return '‡∏ä‡∏≤‡∏¢';
  return '‡∏´‡∏ç‡∏¥‡∏á';
};

// Schema for API: preprocess birthDate string into Date before validation
const apiPatientSchema = z.preprocess((body) => {
  if (body && typeof (body as any).birthDate === 'string') {
    return { ...(body as any), birthDate: new Date((body as any).birthDate) };
  }
  return body;
}, patientFormSchema);

/**
 * POST /api/patients
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Å‡πà‡∏≠‡∏ô
 */
const createPatient: AuthenticatedApiHandler = async (req, _ctx, session) => {
  const allowedRoles = ['COMMUNITY', 'OFFICER', 'ADMIN', 'DEVELOPER'];
  if (!allowedRoles.includes(session.role)) {
    return NextResponse.json({ success: false, error: 'Forbidden' }, { status: 403 });
  }
  try {
    const body = await req.json();
    const parsed = apiPatientSchema.safeParse(body);
    if (!parsed.success) {
      return NextResponse.json(
        { success: false, error: 'Invalid input data', details: parsed.error.flatten() },
        { status: 400 }
      );
    }
    const data = parsed.data;

    const existing = await prisma.patient.findUnique({ where: { nationalId: data.nationalId } });
    if (existing) {
      return NextResponse.json({ success: false, error: '‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß' }, { status: 409 });
    }

    const newPatient = await prisma.patient.create({
      data: {
        prefix: data.prefix,
        gender: getGenderFromPrefix(data.prefix),
        firstName: data.firstName,
        lastName: data.lastName,
        nationalId: data.nationalId,
        birthDate: data.birthDate,
        idCardAddress_houseNumber: data.idCardAddress_houseNumber,
        idCardAddress_moo: data.idCardAddress_moo,
        idCardAddress_tambon: '‡πÄ‡∏ß‡∏µ‡∏¢‡∏á',
        idCardAddress_amphoe: '‡∏ù‡∏≤‡∏á',
        idCardAddress_changwat: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà',
        idCardAddress_phone: data.idCardAddress_phone,
        useIdCardAddress: data.useIdCardAddress,
        currentAddress_houseNumber: data.useIdCardAddress ? data.idCardAddress_houseNumber : data.currentAddress_houseNumber,
        currentAddress_moo: data.useIdCardAddress ? data.idCardAddress_moo : data.currentAddress_moo,
        currentAddress_tambon: data.useIdCardAddress ? '‡πÄ‡∏ß‡∏µ‡∏¢‡∏á' : data.currentAddress_tambon,
        currentAddress_amphoe: data.useIdCardAddress ? '‡∏ù‡∏≤‡∏á' : data.currentAddress_amphoe,
        currentAddress_changwat: data.useIdCardAddress ? '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà' : data.currentAddress_changwat,
        currentAddress_phone: data.useIdCardAddress ? data.idCardAddress_phone : data.currentAddress_phone,
        patientGroup: data.patientGroup,
        otherPatientGroup: data.patientGroup === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ? data.otherPatientGroup : null,
        pickupLocation_lat: data.pickupLocation_lat,
        pickupLocation_lng: data.pickupLocation_lng,
        notes: data.notes,
        basicHealthInfo: data.basicHealthInfo,
        managedByUserId: session.userId
      }
    });

    return NextResponse.json({ success: true, patient: newPatient }, { status: 201 });
  } catch (error) {
    console.error('üî• POST /api/patients Error:', error);
    return NextResponse.json({ success: false, error: 'Internal Server Error' }, { status: 500 });
  }
};

/**
 * GET /api/patients
 * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏î‡∏π‡πÅ‡∏•
 */
const getPatients: AuthenticatedApiHandler = async (_req, _ctx, session) => {
  try {
    const patients = await prisma.patient.findMany({
      where: { managedByUserId: session.userId },
      orderBy: { createdAt: 'desc' }
    });
    return NextResponse.json({ success: true, patients });
  } catch (error) {
    console.error('üî• GET /api/patients Error:', error);
    return NextResponse.json({ success: false, error: 'Internal Server Error' }, { status: 500 });
  }
};

export const POST = withAuth(createPatient);
export const GET = withAuth(getPatients);

import { NextResponse } from 'next/server';
import prisma from '@/lib/prisma';
import { withAuth, type AuthenticatedApiHandler } from '@/lib/auth-handler';
import { patientFormSchema } from '@/schemas/community/patient.schema';
import { z } from 'zod';

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏®
const getGenderFromPrefix = (prefix: string): '‡∏ä‡∏≤‡∏¢' | '‡∏´‡∏ç‡∏¥‡∏á' => {
  if (['‡∏ô‡∏≤‡∏¢', '‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢'].includes(prefix)) return '‡∏ä‡∏≤‡∏¢';
  return '‡∏´‡∏ç‡∏¥‡∏á';
};

// Schema for API: preprocess birthDate string into Date before validation
const apiPatientSchema = z.preprocess((body) => {
  if (body && typeof (body as any).birthDate === 'string') {
    return { ...(body as any), birthDate: new Date((body as any).birthDate) };
  }
  return body;
}, patientFormSchema);

/**
 * POST /api/patients
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Å‡πà‡∏≠‡∏ô
 */
const createPatient: AuthenticatedApiHandler = async (req, _ctx, session) => {
  const allowedRoles = ['COMMUNITY', 'OFFICER', 'ADMIN', 'DEVELOPER'];
  if (!allowedRoles.includes(session.role)) {
    return NextResponse.json({ success: false, error: 'Forbidden' }, { status: 403 });
  }
  try {
    const body = await req.json();
    const parsed = apiPatientSchema.safeParse(body);
    if (!parsed.success) {
      return NextResponse.json(
        { success: false, error: 'Invalid input data', details: parsed.error.flatten() },
        { status: 400 }
      );
    }
    const data = parsed.data;

    const existing = await prisma.patient.findUnique({ where: { nationalId: data.nationalId } });
    if (existing) {
      return NextResponse.json({ success: false, error: '‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß' }, { status: 409 });
    }

    const newPatient = await prisma.patient.create({
      data: {
        prefix: data.prefix,
        gender: getGenderFromPrefix(data.prefix),
        firstName: data.firstName,
        lastName: data.lastName,
        nationalId: data.nationalId,
        birthDate: data.birthDate,
        idCardAddress_houseNumber: data.idCardAddress_houseNumber,
        idCardAddress_moo: data.idCardAddress_moo,
        idCardAddress_tambon: '‡πÄ‡∏ß‡∏µ‡∏¢‡∏á',
        idCardAddress_amphoe: '‡∏ù‡∏≤‡∏á',
        idCardAddress_changwat: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà',
        idCardAddress_phone: data.idCardAddress_phone,
        useIdCardAddress: data.useIdCardAddress,
        currentAddress_houseNumber: data.useIdCardAddress ? data.idCardAddress_houseNumber : data.currentAddress_houseNumber,
        currentAddress_moo: data.useIdCardAddress ? data.idCardAddress_moo : data.currentAddress_moo,
        currentAddress_tambon: data.useIdCardAddress ? '‡πÄ‡∏ß‡∏µ‡∏¢‡∏á' : data.currentAddress_tambon,
        currentAddress_amphoe: data.useIdCardAddress ? '‡∏ù‡∏≤‡∏á' : data.currentAddress_amphoe,
        currentAddress_changwat: data.useIdCardAddress ? '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà' : data.currentAddress_changwat,
        currentAddress_phone: data.useIdCardAddress ? data.idCardAddress_phone : data.currentAddress_phone,
        patientGroup: data.patientGroup,
        otherPatientGroup: data.patientGroup === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ? data.otherPatientGroup : null,
        pickupLocation_lat: data.pickupLocation_lat,
        pickupLocation_lng: data.pickupLocation_lng,
        notes: data.notes,
        basicHealthInfo: data.basicHealthInfo,
        managedByUserId: session.userId
      }
    });

    return NextResponse.json({ success: true, patient: newPatient }, { status: 201 });
  } catch (error) {
    console.error('üî• POST /api/patients Error:', error);
    return NextResponse.json({ success: false, error: 'Internal Server Error' }, { status: 500 });
  }
};

/**
 * GET /api/patients
 * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏î‡∏π‡πÅ‡∏•
 */
const getPatients: AuthenticatedApiHandler = async (_req, _ctx, session) => {
  try {
    const patients = await prisma.patient.findMany({
      where: { managedByUserId: session.userId },
      orderBy: { createdAt: 'desc' }
    });
    return NextResponse.json({ success: true, patients });
  } catch (error) {
    console.error('üî• GET /api/patients Error:', error);
    return NextResponse.json({ success: false, error: 'Internal Server Error' }, { status: 500 });
  }
};

export const POST = withAuth(createPatient);
export const GET = withAuth(getPatients);

import { NextResponse } from 'next/server';
import prisma from '@/lib/prisma';
import { withAuth, type AuthenticatedApiHandler } from '@/lib/auth-handler';
import { patientFormSchema } from '@/schemas/community/patient.schema';
import { z } from 'zod';

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏®
const getGenderFromPrefix = (prefix: string): '‡∏ä‡∏≤‡∏¢' | '‡∏´‡∏ç‡∏¥‡∏á' => {
  if (['‡∏ô‡∏≤‡∏¢', '‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢'].includes(prefix)) return '‡∏ä‡∏≤‡∏¢';
  return '‡∏´‡∏ç‡∏¥‡∏á';
};

// Schema for API: preprocess birthDate string into Date before validation
const apiPatientSchema = z.preprocess((body) => {
  if (body && typeof (body as any).birthDate === 'string') {
    return { ...(body as any), birthDate: new Date((body as any).birthDate) };
  }
  return body;
}, patientFormSchema);

/**
 * POST /api/patients
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Å‡πà‡∏≠‡∏ô
 */
const createPatient: AuthenticatedApiHandler = async (req, _ctx, session) => {
  const allowedRoles = ['COMMUNITY', 'OFFICER', 'ADMIN', 'DEVELOPER'];
  if (!allowedRoles.includes(session.role)) {
    return NextResponse.json({ success: false, error: 'Forbidden' }, { status: 403 });
  }
  try {
    const body = await req.json();
    const parsed = apiPatientSchema.safeParse(body);
    if (!parsed.success) {
      return NextResponse.json(
        { success: false, error: 'Invalid input data', details: parsed.error.flatten() },
        { status: 400 }
      );
    }
    const data = parsed.data;
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
    const existing = await prisma.patient.findUnique({ where: { nationalId: data.nationalId } });
    if (existing) {
      return NextResponse.json({ success: false, error: '‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß' }, { status: 409 });
    }
    const newPatient = await prisma.patient.create({
      data: {
        prefix: data.prefix,
        gender: getGenderFromPrefix(data.prefix),
        firstName: data.firstName,
        lastName: data.lastName,
        nationalId: data.nationalId,
        birthDate: data.birthDate,
        idCardAddress_houseNumber: data.idCardAddress_houseNumber,
        idCardAddress_moo: data.idCardAddress_moo,
        idCardAddress_tambon: '‡πÄ‡∏ß‡∏µ‡∏¢‡∏á',
        idCardAddress_amphoe: '‡∏ù‡∏≤‡∏á',
        idCardAddress_changwat: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà',
        idCardAddress_phone: data.idCardAddress_phone,
        useIdCardAddress: data.useIdCardAddress,
        currentAddress_houseNumber: data.useIdCardAddress ? data.idCardAddress_houseNumber : data.currentAddress_houseNumber,
        currentAddress_moo: data.useIdCardAddress ? data.idCardAddress_moo : data.currentAddress_moo,
        currentAddress_tambon: data.useIdCardAddress ? '‡πÄ‡∏ß‡∏µ‡∏¢‡∏á' : data.currentAddress_tambon,
        currentAddress_amphoe: data.useIdCardAddress ? '‡∏ù‡∏≤‡∏á' : data.currentAddress_amphoe,
        currentAddress_changwat: data.useIdCardAddress ? '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà' : data.currentAddress_changwat,
        currentAddress_phone: data.useIdCardAddress ? data.idCardAddress_phone : data.currentAddress_phone,
        patientGroup: data.patientGroup,
        otherPatientGroup: data.patientGroup === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ? data.otherPatientGroup : null,
        pickupLocation_lat: data.pickupLocation_lat,
        pickupLocation_lng: data.pickupLocation_lng,
        notes: data.notes,
        basicHealthInfo: data.basicHealthInfo,
        managedByUserId: session.userId
      }
    });
    return NextResponse.json({ success: true, patient: newPatient }, { status: 201 });
  } catch (error) {
    console.error('üî• POST /api/patients Error:', error);
    return NextResponse.json({ success: false, error: 'Internal Server Error' }, { status: 500 });
  }
};

/**
 * GET /api/patients
 * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏î‡∏π‡πÅ‡∏•
 */
const getPatients: AuthenticatedApiHandler = async (_req, _ctx, session) => {
  try {
    const patients = await prisma.patient.findMany({
      where: { managedByUserId: session.userId },
      orderBy: { createdAt: 'desc' }
    });
    return NextResponse.json({ success: true, patients });
  } catch (error) {
    console.error('üî• GET /api/patients Error:', error);
    return NextResponse.json({ success: false, error: 'Internal Server Error' }, { status: 500 });
  }
};

export const POST = withAuth(createPatient);
export const GET = withAuth(getPatients);


import { NextResponse } from 'next/server';
import prisma from '@/lib/prisma';
import { withAuth, type AuthenticatedApiHandler } from '@/lib/auth-handler';
import { patientFormSchema } from '@/schemas/community/patient.schema';
import { z } from 'zod';

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏®
const getGenderFromPrefix = (prefix: string): '‡∏ä‡∏≤‡∏¢' | '‡∏´‡∏ç‡∏¥‡∏á' => {
  if (['‡∏ô‡∏≤‡∏¢', '‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢'].includes(prefix)) {
    return '‡∏ä‡∏≤‡∏¢';
  }
  return '‡∏´‡∏ç‡∏¥‡∏á';
};


const apiPatientSchema = patientFormSchema.extend({
  birthDate: z.string().transform((str) => new Date(str)),
});

/**
 * Handler ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà
 * POST /api/patients
 */
const createPatient: AuthenticatedApiHandler = async (req, context, session) => {
  const allowedRoles: string[] = ['COMMUNITY', 'OFFICER', 'ADMIN', 'DEVELOPER'];
  if (!allowedRoles.includes(session.role)) {
    return NextResponse.json({ success: false, error: 'Forbidden' }, { status: 403 });
  }

  try {
    const body = await req.json();
    // ‡πÉ‡∏ä‡πâ Schema ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö API ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Parse ‡πÅ‡∏•‡∏∞ Transform ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const parsedData = apiPatientSchema.safeParse(body);

    if (!parsedData.success) {
      return NextResponse.json({ success: false, error: 'Invalid input data', details: parsedData.error.flatten() }, { status: 400 });
    }
    
    const data = parsedData.data;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏Ç‡∏≠‡∏á nationalId
    const existingPatient = await prisma.patient.findUnique({
      where: { nationalId: data.nationalId },
    });
    if (existingPatient) {
      return NextResponse.json({ success: false, error: '‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß' }, { status: 409 });
    }

    const newPatient = await prisma.patient.create({
      data: {
        ...data,
        // birthDate ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô Date object ‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Prisma ‡πÅ‡∏•‡πâ‡∏ß
        birthDate: data.birthDate,
        // gender ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡πâ‡∏ß
        gender: data.gender,
        
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà)
        idCardAddress_tambon: '‡πÄ‡∏ß‡∏µ‡∏¢‡∏á',
        idCardAddress_amphoe: '‡∏ù‡∏≤‡∏á',
        idCardAddress_changwat: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà',

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
        currentAddress_houseNumber: data.useIdCardAddress ? data.idCardAddress_houseNumber : data.currentAddress_houseNumber,
        currentAddress_moo: data.useIdCardAddress ? data.idCardAddress_moo : data.currentAddress_moo,
        currentAddress_tambon: data.useIdCardAddress ? '‡πÄ‡∏ß‡∏µ‡∏¢‡∏á' : data.currentAddress_tambon,
        currentAddress_amphoe: data.useIdCardAddress ? '‡∏ù‡∏≤‡∏á' : data.currentAddress_amphoe,
        currentAddress_changwat: data.useIdCardAddress ? '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà' : data.currentAddress_changwat,
        currentAddress_phone: data.useIdCardAddress ? data.idCardAddress_phone : data.currentAddress_phone,

        otherPatientGroup: data.patientGroup === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ? data.otherPatientGroup : null,

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ
        managedByUserId: session.userId, 
      }
    });

    return NextResponse.json({ success: true, patient: newPatient }, { status: 201 });

  } catch (error) {
    console.error('üî• POST /api/patients Error:', error);
    return NextResponse.json({ success: false, error: 'Internal Server Error' }, { status: 500 });
  }
};

/**
 * Handler ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏π‡πÅ‡∏•‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
 * GET /api/patients
 */
const getPatients: AuthenticatedApiHandler = async (req, context, session) => {
  try {
    const patients = await prisma.patient.findMany({
      where: { managedByUserId: session.userId },
      orderBy: { createdAt: 'desc' }
    });

    return NextResponse.json({ success: true, patients });

  } catch (error) {
    console.error('üî• GET /api/patients Error:', error);
    return NextResponse.json({ success: false, error: 'Internal Server Error' }, { status: 500 });
  }
};

export const POST = withAuth(createPatient);
export const GET = withAuth(getPatients);
import prisma from '@/lib/prisma';
import { withAuth, type AuthenticatedApiHandler } from '@/lib/auth-handler';
import { patientFormSchema } from '@/schemas/community/patient.schema';
import { z } from 'zod';

// [NEW] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏®
const getGenderFromPrefix = (prefix: string): '‡∏ä‡∏≤‡∏¢' | '‡∏´‡∏ç‡∏¥‡∏á' => {
  if (['‡∏ô‡∏≤‡∏¢', '‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢'].includes(prefix)) return '‡∏ä‡∏≤‡∏¢';
  return '‡∏´‡∏ç‡∏¥‡∏á';
};

/**
 * POST /api/patients
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Å‡πà‡∏≠‡∏ô
 */
const createPatient: AuthenticatedApiHandler = async (req, _ctx, session) => {
  const allowedRoles: string[] = ['COMMUNITY', 'OFFICER', 'ADMIN', 'DEVELOPER'];
  if (!allowedRoles.includes(session.role)) {
    return NextResponse.json({ success: false, error: 'Forbidden' }, { status: 403 });
  }

  try {
    const body = await req.json();
    const parsed = patientFormSchema.safeParse(body);
    if (!parsed.success) {
      return NextResponse.json(
        { success: false, error: 'Invalid input data', details: parsed.error.flatten() },
        { status: 400 }
      );
    }
    const data = parsed.data;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏Ç‡∏≠‡∏á nationalId
    const existing = await prisma.patient.findUnique({ where: { nationalId: data.nationalId } });
    if (existing) {
      return NextResponse.json({ success: false, error: '‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß' }, { status: 409 });
    }

    const newPatient = await prisma.patient.create({
      data: {
        prefix: data.prefix,
        gender: getGenderFromPrefix(data.prefix),
        firstName: data.firstName,
        lastName: data.lastName,
        nationalId: data.nationalId,

        // @ts-ignore: ensure birthDate property is accepted by Prisma schema
        birthDate: new Date(data.birthDate),
        idCardAddress_houseNumber: data.idCardAddress_houseNumber,
        idCardAddress_moo: data.idCardAddress_moo,
        idCardAddress_tambon: '‡πÄ‡∏ß‡∏µ‡∏¢‡∏á',
        idCardAddress_amphoe: '‡∏ù‡∏≤‡∏á',
        idCardAddress_changwat: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà',
        idCardAddress_phone: data.idCardAddress_phone,
        useIdCardAddress: data.useIdCardAddress,
        currentAddress_houseNumber: data.useIdCardAddress
          ? data.idCardAddress_houseNumber
          : data.currentAddress_houseNumber,
        currentAddress_moo: data.useIdCardAddress ? data.idCardAddress_moo : data.currentAddress_moo,
        currentAddress_tambon: data.useIdCardAddress ? '‡πÄ‡∏ß‡∏µ‡∏¢‡∏á' : data.currentAddress_tambon,
        currentAddress_amphoe: data.useIdCardAddress ? '‡∏ù‡∏≤‡∏á' : data.currentAddress_amphoe,
        currentAddress_changwat: data.useIdCardAddress ? '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà' : data.currentAddress_changwat,
        currentAddress_phone: data.useIdCardAddress ? data.idCardAddress_phone : data.currentAddress_phone,
        patientGroup: data.patientGroup,
        otherPatientGroup: data.patientGroup === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ? data.otherPatientGroup : null,
        
        pickupLocation_lat: data.pickupLocation_lat,
        pickupLocation_lng: data.pickupLocation_lng,
        notes: data.notes,
        managedByUserId: session.userId,
      },
    });

    return NextResponse.json({ success: true, patient: newPatient }, { status: 201 });
  } catch (error) {
    console.error('üî• POST /api/patients Error:', error);
    return NextResponse.json({ success: false, error: 'Internal Server Error' }, { status: 500 });
  }
};

export const POST = withAuth(createPatient);

